<!-- 
 
"id": 1,
"nome": "Administrador",
"email": "admin@sgqui.com",
"permissao": 0,
"avatar": null,
"status": 1,
"createdAt": "2024-06-05T09:56:50.000Z",
"updatedAt": "2024-06-05T09:56:50.000Z" -->


<h2>Usuários</h2>
<div class="table-responsive">
    <table id="tabela-usuario" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Avatar</th>
                <th>Nome</th>
                <th>Login</th>
                <th>Perfis</th>
                <th>Ações</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <!-- Os dados da tabela serão preenchidos dinamicamente pelo DataTable -->
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="detalhesModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Detalhes do usuario</h5>
                <button type="button" class="btn-close btn-fecha-modal" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <form id="formEditarUsuario">
                <div class="modal-body" id="detalhesUsuario">
                    <!-- Detalhes do usuario serão exibidos aqui -->
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnEditar" class="btn btn-outline-secondary btn-sm">Editar</button>
                    <button type="submit" id="btnSalvar" class="btn btn-outline-secondary btn-sm d-none">Salvar
                        Alterações</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm btn-fecha-modal"
                        data-bs-dismiss="modal">Fechar</button>
                </div>
            </form>

        </div>
    </div>
</div>


<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="confirmacaoExclusaoModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close btn-fecha-modal" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Deseja realmente excluir o item <b id="nomeExclui"></b>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="confirmarExclusao">Confirmar Exclusão</button>
                <button type="button" class="btn btn-secondary btn-fecha-modal"
                    data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {

        let data;
        let table;
        let alterado = 0;
        let vinculosAtuais = [];
        const sessionUs = getSessionData('us') || {};
        const usuarioLogadoId = sessionUs && sessionUs.id ? String(sessionUs.id) : null;

        const hasPerm = (key) => {
            const permissoesSessao = getPermissoes();
            return permissoesSessao && permissoesSessao[key] === true;
        };

        if (!hasPerm('usuario:cadastrar')) {
            $('#btnCadastrarUsuario, .btn-cadastrar-usuario').addClass('d-none');
        }

        req_GET(opt.urlUsuario).then((result) => {

            if (!result.success) {
                // Tratamento de erro
                let errorMessage;
                errorMessage = `${result.message || 'Erro desconhecido.'}`;
                // Usa a função showToast para mostrar o erro
                showToast(errorMessage, 'error');
                return;
            }

            data = result.data;

            const normalizarPerfis = (res) => {
                const payload = res && res.data;
                if (Array.isArray(payload)) return payload;
                if (payload && Array.isArray(payload.perfis)) return payload.perfis;
                if (payload && payload.perfil) return [payload.perfil];
                return [];
            };

            const carregarPerfisUsuarios = (usuarios) => {
                const lista = usuarios || [];
                return Promise.all(lista.map(usuario => {
                    return req_GET(`${opt.urlUsuarioPerfis}/usuario/${usuario.id}/perfis/`)
                        .then(res => {
                            const perfis = normalizarPerfis(res);
                            const nomes = perfis.map(p => p.nome).filter(Boolean);
                            return { ...usuario, perfisNomes: nomes.join(', ') };
                        })
                        .catch(() => ({ ...usuario, perfisNomes: '' }));
                }));
            };

            carregarPerfisUsuarios(data).then((usuariosComPerfis) => {
                data = usuariosComPerfis;

                // INICIA DATATABLE
                table = $('#tabela-usuario').DataTable({
                    data: data,
                    order: [[5, 'desc']],
                    columns: [
                        {
                            title: 'Avatar',
                            data: 'avatar',
                            orderable: false,
                            render: function (data, type, row) {
                                const safeAlt = (row && row.nome) ? row.nome : 'Avatar';
                                const src = data || AVATAR_DEFAULT_SRC;
                                return `
                                                                    <img src="${src}" alt="${safeAlt}" class="rounded-circle border" style="width: 36px; height: 36px; object-fit: cover;">
                                `;
                            }
                        },
                        { title: 'Nome', data: 'nome' },
                        { title: 'Login', data: 'email' },
                        { title: 'Perfis', data: 'perfisNomes' },
                        { // Coluna para os botões de ação
                            title: 'Ações',
                            data: null,
                            orderable: false,

                            render: function (data, type, row) {
                                const isLogado = usuarioLogadoId && String(row.id) === usuarioLogadoId;
                                const canView = isLogado ? hasPerm('usuario:consultarLogado') : hasPerm('usuario:consultarPorId');
                                const canEdit = isLogado ? hasPerm('usuario:alterarPerfilLogado') : hasPerm('usuario:alterar');
                                const canDelete = isLogado ? hasPerm('usuario:deletarPerfilLogado') : hasPerm('usuario:deletar');

                                const botaoDetalhes = canView
                                    ? `<button class="btn btn-outline-secondary btn-sm btn-detalhes-editar" data-id="${row.id}" data-toggle="modal" data-target="#detalhesModal" title="${canEdit ? 'Ver/Editar' : 'Ver'}"><i class="fa-solid fa-eye"></i>${canEdit ? '/<i class=\"fa-solid fa-pen-to-square\"></i>' : ''}</button>`
                                    : '';
                                const botaoExcluir = canDelete
                                    ? `<button class="btn btn-outline-secondary btn-sm btn-excluir" data-id="${row.id}" data-nome="${row.nome}" title="Excluir"><i class="fa-solid fa-ban"></i></button>`
                                    : '';
                                return `
                              ${botaoDetalhes}
                              ${botaoExcluir}
                          `;
                            }
                        },
                        { title: 'Update', data: 'updatedAt', visible: false }
                    ],
                    columnDefs: [
                        { targets: 4, autoWidth: true } // Ativa o ajuste automático da largura para a coluna ações
                    ],
                    // Habilita a pesquisa global
                    searching: true
                });
                //FIM DATATABLE



                // Adiciona campos de pesquisa em cada cabeçalho de coluna
                $('#tabela-usuario thead th').each(function () {
                    let title = $(this).text();
                    if (title !== "Ações" && title !== "Avatar") {
                        $(this).html(`<input type="text" class="form-control form-control-sm" placeholder="${title} "/>`);
                    }
                });

                // Adiciona um evento de pesquisa para cada campo de entrada de texto nas colunas
                $('#tabela-usuario thead th input').on('keyup', function () {
                    let columnIndex = $(this).closest('th').index(); // Obtém o índice da coluna
                    table.column(columnIndex).search(this.value).draw();
                });


                ///////////////EDITAR///////////////////////
                //Abre modal de visualização e edição de usuario
                $('#tabela-usuario').on('click', '.btn-detalhes-editar', function () {
                    const id = $(this).data('id');
                    const isLogado = usuarioLogadoId && String(id) === usuarioLogadoId;
                    const canView = isLogado ? hasPerm('usuario:consultarLogado') : hasPerm('usuario:consultarPorId');
                    if (!canView) {
                        showToast('Sem permissão para consultar usuário.', 'warning');
                        return;
                    }
                    const usuario = data.find(item => item.id === id);
                    exibirDetalhes(usuario);
                });


                // Função para exibir os detalhes em um modal
                function exibirDetalhes(usuario) {
                    const isLogado = usuarioLogadoId && String(usuario.id) === usuarioLogadoId;
                    const canEdit = isLogado ? hasPerm('usuario:alterarPerfilLogado') : hasPerm('usuario:alterar');
                    const canViewPerfis = isLogado ? hasPerm('usuario_perfis:listarDoUsuarioLogado') : hasPerm('usuario_perfis:listarPerfisPorUsuario');
                    const canVincular = hasPerm('usuario_perfis:vincular');
                    const canDesvincular = hasPerm('usuario_perfis:desvincular');
                    const avatarSrc = usuario.avatar ? usuario.avatar : AVATAR_DEFAULT_SRC;
                    let html = `
                <div class="form-group">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Avatar:</label>
                                            <div class="mb-2">
                                                <img id="previewAvatarEdit" src="${avatarSrc}" alt="Avatar" class="rounded-circle border" style="width: 80px; height: 80px; object-fit: cover;">
                                            </div>
                                            <input type="file" class="form-control" id="avatarInputEdit" name="avatar"
                                                accept="image/jpeg,image/png,image/gif" disabled>
                                            <small class="text-muted">Tamanho maximo: 5MB (sera redimensionado para 100x100px)</small>
                                        </div>
                    <div class="form-group">
                      <label for="nome">Nome:</label>
                      <input type="text" class="form-control" id="nome" name="nome" value="${usuario.nome}" readonly>
                    </div>
                    <div class="form-group">
                      <label for="email">Email:</label>
                      <input type="email" class="form-control" id="email" name="email" value="${usuario.email}" readonly>
                    </div>
                    <div class="form-group">
                      <label for="senha">Nova senha:</label>
                      <input type="password" class="form-control" id="senha" name="senha" placeholder="******" readonly minlength="6">
                    </div>
                    ${canViewPerfis ? `<div class="form-group" id="perfisEditSection">
                      <label class="form-label">Perfis:</label>
                      <div id="perfisEditContainer" class="border rounded p-2" style="max-height: 220px; overflow-y: auto;"></div>
                    </div>` : ''}
                    <input type="hidden" id="id" name="id" value="${usuario.id}">
                    <input type="hidden" id="canViewPerfis" value="${canViewPerfis}">
                    <input type="hidden" id="canVincular" value="${canVincular}">
                    <input type="hidden" id="canDesvincular" value="${canDesvincular}">
                    <input type="hidden" id="perfilVinculoId" name="perfilVinculoId" value="">
                    <input type="hidden" id="perfilAtualId" name="perfilAtualId" value="">
                </div>
                 `;

                    $('#detalhesUsuario').html(html);
                    $('#detalhesModal').modal('show');
                    configurarPreviewAvatar('#avatarInputEdit', '#previewAvatarEdit');

                    if (!canEdit && !isLogado) {
                        // Não é usuário logado e não tem permissão: bloqueia tudo
                        $('#btnEditar').addClass('d-none');
                        $('#btnSalvar').addClass('d-none');
                        $('#avatarInputEdit').prop('disabled', true);
                        $('.form-control').prop('readonly', true);
                    } else if (isLogado && !canEdit) {
                        // É usuário logado mas sem permissão completa: permite apenas senha e avatar
                        $('#nome').prop('readonly', true);
                        $('#email').prop('readonly', true);
                    }

                    if (canViewPerfis) {
                        carregarVinculoUsuario(usuario.id).then(({ vinculos, perfilIds }) => {
                            vinculosAtuais = vinculos;
                            return carregarPerfisEdicao(perfilIds);
                        }).catch(error => {
                            showToast(`Erro de comunicação: ${error.message || 'Erro desconhecido.'}`, 'error');
                        });
                    }
                }

                function carregarPerfisEdicao(selectedIds) {
                    return req_GET(opt.urlPerfis).then(result => {
                        if (!result.success) {
                            showToast(result.message || 'Erro ao carregar perfis.', 'error');
                            return;
                        }

                        const canViewPerfis = $('#canViewPerfis').val() === 'true';
                        if (!canViewPerfis) return;

                        const isLogado = usuarioLogadoId && String($('#id').val()) === usuarioLogadoId;
                        const canEdit = isLogado ? hasPerm('usuario:alterarPerfilLogado') : hasPerm('usuario:alterar');
                        const canVincular = $('#canVincular').val() === 'true';
                        const canDesvincular = $('#canDesvincular').val() === 'true';
                        const canManagePerfis = canVincular && canDesvincular;
                        const container = $('#perfisEditContainer').empty();
                        const selecionados = new Set((selectedIds || []).map(String));
                        (result.data || []).forEach(p => {
                            const checked = selecionados.has(String(p.id)) ? 'checked' : '';
                            const disabled = (canEdit && canManagePerfis) ? '' : 'disabled';
                            const item = $(`
                  <div class="form-check">
                    <input class="form-check-input perfil-checkbox-edit" type="checkbox" id="perfil_edit_${p.id}" value="${p.id}" ${checked} ${disabled}>
                    <label class="form-check-label" for="perfil_edit_${p.id}">${p.nome}</label>
                  </div>
                `);
                            container.append(item);
                        });
                    });
                }

                function getPerfisSelecionadosEdicao() {
                    return $('#perfisEditContainer .perfil-checkbox-edit:checked')
                        .map((_, el) => String($(el).val()))
                        .get();
                }

                function carregarVinculoUsuario(usuarioId) {
                    return req_GET(opt.urlUsuarioPerfis + '/usuario/' + usuarioId + '/perfis/').then(result => {
                        const data = result && result.data;
                        if (!result.success) {
                            return { vinculos: [], perfilIds: [] };
                        }

                        let items = [];
                        if (Array.isArray(data)) items = data;
                        else if (data && Array.isArray(data.perfis)) items = data.perfis;
                        else if (data && data.perfil) items = [data.perfil];

                        const vinculos = items.map(v => ({
                            vinculoId: v.id || v.vinculoId || v.vinculo_id || v.usuarioPerfilId || v.usuario_perfil_id || '',
                            perfilId: v.perfilId || (v.perfil && v.perfil.id) || v.id_perfil || v.id || ''
                        })).filter(v => v.perfilId);

                        return { vinculos, perfilIds: vinculos.map(v => String(v.perfilId)) };
                    });
                }


                // Adicionar evento de clique para o botão "Editar"
                $('#detalhesModal').on('click', '#btnEditar', function () {
                    const userId = String($('#id').val() || '');
                    const isLogado = usuarioLogadoId && userId === usuarioLogadoId;
                    const canEdit = isLogado ? hasPerm('usuario:alterarPerfilLogado') : hasPerm('usuario:alterar');
                    
                    // Se não é usuário logado e não tem permissão, bloqueia
                    if (!canEdit && !isLogado) {
                        showToast('Sem permissão para editar usuário.', 'warning');
                        return;
                    }
                    
                    const canVincular = $('#canVincular').val() === 'true';
                    const canDesvincular = $('#canDesvincular').val() === 'true';
                    const canManagePerfis = canVincular && canDesvincular;
                    
                    // Usuário logado sempre pode editar senha e avatar
                    if (isLogado) {
                        $('#senha').prop('readonly', false);
                        $('#avatarInputEdit').prop('disabled', false);
                        
                        // Nome e email só libera se tiver permissão
                        if (canEdit) {
                            $('#nome').prop('readonly', false);
                            $('#email').prop('readonly', false);
                        }
                    } else if (canEdit) {
                        // Outro usuário com permissão: libera tudo
                        $('.form-control').prop('readonly', false);
                        $('#avatarInputEdit').prop('disabled', false);
                    }
                    
                    // Perfis só se tiver permissão
                    if (canManagePerfis) {
                        $('#perfisEditContainer .perfil-checkbox-edit').prop('disabled', false);
                    }
                    
                    $('#btnEditar').addClass('d-none');
                    $('#btnSalvar').removeClass('d-none');
                });

                // Adicionar evento de submit para o formulário de edição do usuario
                $('#formEditarUsuario').on('submit', function (event) {

                    event.preventDefault(); // Impedir o envio padrão do formulário
                    const jsonData = serializadoParaJSON($(this).serialize());

                    const userId = String(jsonData.id || '');
                    const isLogado = usuarioLogadoId && userId === usuarioLogadoId;
                    const canEdit = isLogado ? hasPerm('usuario:alterarPerfilLogado') : hasPerm('usuario:alterar');
                    
                    // Se não é usuário logado e não tem permissão, bloqueia
                    if (!canEdit && !isLogado) {
                        showToast('Sem permissão para editar usuário.', 'warning');
                        return;
                    }
                    
                    // Se é usuário logado sem permissão completa, remove campos que não pode editar
                    if (isLogado && !canEdit) {
                        delete jsonData.nome;
                        delete jsonData.email;
                    }

                    if (!jsonData.senha || String(jsonData.senha).trim() === '') {
                        delete jsonData.senha;
                    }

                    const usuarioId = parseInt(jsonData.id, 10);
                    const canViewPerfis = $('#canViewPerfis').val() === 'true';
                    const canVincular = $('#canVincular').val() === 'true';
                    const canDesvincular = $('#canDesvincular').val() === 'true';
                    const canManagePerfis = canVincular && canDesvincular;
                    
                    const selecionados = canViewPerfis && canManagePerfis ? getPerfisSelecionadosEdicao() : [];
                    const avatarFile = $('#avatarInputEdit')[0] ? $('#avatarInputEdit')[0].files[0] : null;

                    delete jsonData.perfilIdsEdit;
                    delete jsonData.perfilVinculoId;
                    delete jsonData.perfilAtualId;
                    delete jsonData.canViewPerfis;
                    delete jsonData.canVincular;
                    delete jsonData.canDesvincular;

                    const atuaisIds = new Set(vinculosAtuais.map(v => String(v.perfilId)));
                    const selecionadosSet = new Set(selecionados);

                    const paraRemover = (canViewPerfis && canManagePerfis && canDesvincular) 
                        ? vinculosAtuais.filter(v => !selecionadosSet.has(String(v.perfilId)) && v.vinculoId) 
                        : [];
                    const paraAdicionar = (canViewPerfis && canManagePerfis && canVincular) 
                        ? selecionados.filter(id => !atuaisIds.has(String(id))) 
                        : [];

                    const prepararAvatar = avatarFile ? obterAvatarBase64(avatarFile) : Promise.resolve(null);

                    prepararAvatar.then((base64) => {
                        if (base64) {
                            jsonData.avatar = base64;
                        }
                        return req_PUT(opt.urlUsuario + "/" + jsonData.id, jsonData);
                    })
                        .then(result => {
                            if (!result.success) {
                                // Tratamento de erro
                                let errorMessage;
                                errorMessage = `${result.message || 'Erro desconhecido.'}`;
                                // Usa a função showToast para mostrar o erro
                                showToast(errorMessage, 'error');
                                return;
                            }

                            const sessionUs = getSessionData('us');
                            if (sessionUs && String(sessionUs.id) === String(jsonData.id)) {
                                const payload = Array.isArray(result.data) ? result.data[0] : result.data || {};
                                if (payload.avatar) {
                                    sessionUs.avatar = payload.avatar;
                                    $('#userAvatar').attr('src', payload.avatar);
                                }
                                if (payload.nome) {
                                    sessionUs.nome = payload.nome;
                                    $('#userName').text(payload.nome);
                                }
                                setSessionData('us', sessionUs);
                            }

                            const desvincular = Promise.all(
                                paraRemover.map(v => req_DELETE(opt.urlUsuarioPerfis + "/" + v.vinculoId))
                            );

                            const vincular = paraAdicionar.length
                                ? Promise.all(paraAdicionar.map(perfilId => req_POST(opt.urlUsuarioPerfis, { usuarioId, perfilId: parseInt(perfilId, 10) })))
                                : Promise.resolve();

                            return desvincular.then(() => vincular);
                        })
                        .then(() => {
                            showToast('Usuário atualizado com sucesso!', 'success');
                            $('#detalhesModal').modal('hide');
                            alterado = 1;
                        }).catch(error => {
                            // Tratamento de erro de rede ou erro inesperado
                            showToast(`Erro de comunicação: ${error.message || 'Erro desconhecido.'}`, 'error');
                        });
                });

                //Limpa modal ao fechar
                $('#detalhesModal').on('hidden.bs.modal', function () {
                    $('#detalhesUsuario').empty(); // Limpar o conteúdo do usuario com id 'detalhesUsuario'
                    $('#btnSalvar').addClass('d-none'); // Ocultar o botão "Salvar"
                    $('#btnEditar').removeClass('d-none'); // Exibir o botão "Editar"
                });
                ///////////////FIM EDITAR///////////////////////

                ///////////////EXCLUIR///////////////////////
                // Adicionar evento de clique para o botão "Excluir"
                $('#tabela-usuario').on('click', '.btn-excluir', function () {
                    const id = $(this).data('id');
                    const nome = $(this).data('nome');
                    const isLogado = usuarioLogadoId && String(id) === usuarioLogadoId;
                    const canDelete = isLogado ? hasPerm('usuario:deletarPerfilLogado') : hasPerm('usuario:deletar');
                    if (!canDelete) {
                        showToast('Sem permissão para excluir usuário.', 'warning');
                        return;
                    }
                    // Faça algo com o ID, como confirmar a exclusão do usuario
                    excluirUsuario(id, nome);
                });

                function excluirUsuario(id, nome) {

                    if (id == 1) {
                        showToast("Não é permitido excluir este usuário!", 'error');
                        return;
                    }
                    // Exibe o modal de confirmação de exclusão com o nome do item
                    $('#nomeExclui').text(nome);
                    $('#confirmacaoExclusaoModal').modal('show');

                    // Evento ao clicar no botão "Confirmar Exclusão" no modal de confirmação
                    $('#confirmarExclusao').on('click', function () {

                        req_DELETE(opt.urlUsuario + "/" + id).then((response) => {
                            if (!result.success) {
                                // Tratamento de erro
                                let errorMessage;
                                errorMessage = `${result.message || 'Erro desconhecido.'}`;
                                // Usa a função showToast para mostrar o erro
                                showToast(errorMessage, 'error');
                                return;
                            }
                            // Fecha o modal de confirmação de exclusão
                            $('#confirmacaoExclusaoModal').modal('hide');
                            alterado = 1;
                        }).catch(error => {
                            // Tratamento de erro de rede ou erro inesperado
                            showToast(`Erro de comunicação: ${error.message || 'Erro desconhecido.'}`, 'error');
                        });
                    });
                }

                // FUNCOES AUXILIARES
                // FUNÇÕES AUXILIARES
                $('.modal').on('hidden.bs.modal', function () {
                    if (alterado !== 0) {
                        req_GET(opt.urlUsuario).then((res) => {
                            let data = res.data; // Certifique-se de que 'data' está na resposta correta
                            if (data && table) {
                                carregarPerfisUsuarios(data).then((usuariosComPerfis) => {
                                    table.clear().rows.add(usuariosComPerfis).draw();
                                });
                            } else {
                                console.error("Erro: Dados ou tabela não encontrados.");
                            }
                        }).catch((error) => {
                            console.error("Erro ao fazer a requisição:", error);
                        });
                    }
                });

            });
        })
    })
</script>