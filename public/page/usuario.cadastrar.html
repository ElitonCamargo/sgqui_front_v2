<h2>Cadastrar Usuário</h2>
<div id="msgResult">

</div>
<form class="container mt-5" id="formCadastrarUsuario">
  <div class="row">
    <div class="col-md-4">
      <label for="nome" class="form-label">Nome</label>
      <input type="text" class="form-control" id="nome" name="nome" required>
    </div>

    <div class="col-md-4">
      <label for="login" class="form-label">Login</label>
      <input type="email" class="form-control" id="login" name="email" required>
    </div>

    <div class="col-md-4">
      <label for="senha" class="form-label">Senha</label>
      <div class="input-group">
        <input type="password" class="form-control" id="senha" name="senha" required>
        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
          <i id="icon" class="fa fa-eye"></i>
        </button>
      </div>
    </div>

    <div class="col-md-4">
      <label class="form-label">Avatar</label>
      <div class="mb-2">
        <img id="previewAvatar" src="/assets/img/user-default.png" alt="Avatar"
          class="rounded-circle border" style="width: 100px; height: 100px; object-fit: cover;">
      </div>
      <input type="file" class="form-control" id="avatarInput" name="avatar"
        accept="image/jpeg,image/png,image/gif">
      <small class="text-muted">Tamanho maximo: 5MB (sera redimensionado para 100x100px)</small>
    </div>

    <div class="col-md-4">
      <label class="form-label">Perfis</label>
      <div id="perfisCadastroContainer" class="border rounded p-2" style="max-height: 220px; overflow-y: auto;">
        <!-- Checkboxes serão carregados aqui -->
      </div>
    </div>

  </div>
  <button class="btn btn-primary" type="submit" id="usuarioCadastrar">Cadastrar</button>
</form>

<!-- Modal de Confirmação de Cadastro -->
<div class="modal fade" id="confirmacaoCadastroModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirma Cadastro</h5>
        <button type="button" class="btn-close btn-fecha-modal" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-fecha-modal" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>

  $(function () {


    configurarPreviewAvatar('#avatarInput', '#previewAvatar');

    // Adicionar evento de submit para o formulário de edição do nutriente
    $('#formCadastrarUsuario').on('submit', function (event) {

      event.preventDefault(); // Impedir o envio padrão do formulário
      const jsonData = serializadoParaJSON($(this).serialize());
      const perfilIds = getPerfisSelecionadosCadastro();
      const avatarFile = $('#avatarInput')[0].files[0];

      delete jsonData.perfilIds;

      const prepararAvatar = avatarFile ? obterAvatarBase64(avatarFile) : Promise.resolve(null);

      prepararAvatar.then((base64) => {
        if (base64) {
          jsonData.avatar = base64;
        }
        return req_POST(opt.usuario, jsonData);
      }).then(result => {
        if (!result.success) {
          // Tratamento de erro
          let errorMessage;
          errorMessage = `${result.message || 'Erro desconhecido.'}`;
          // Usa a função showToast para mostrar o erro
          showToast(errorMessage, 'error');
          return Promise.reject(new Error(errorMessage));
        }

        const usuario = Array.isArray(result.data) ? result.data[0] : result.data;
        const usuarioId = usuario && usuario.id ? usuario.id : null;

        if (usuarioId && perfilIds.length > 0) {
          return Promise.all(
            perfilIds.map(perfilId => req_POST(opt.urlUsuarioPerfis, { usuarioId, perfilId }))
          ).then(() => usuario);
        }

        return usuario;
      }).then(usuario => {
        if (!usuario) return;
        showToast('Usuário cadastrado com sucesso!', 'success');
        $('#confirmacaoCadastroModal .modal-body').html(`<b>${usuario.nome}</b> cadastrado com sucesso!`);
        $('#confirmacaoCadastroModal').modal('show');
        $('#formCadastrarUsuario')[0].reset();
        $('#avatarInput').val('');
        $('#previewAvatar').attr('src', AVATAR_DEFAULT_SRC);
      }).catch(error => {
        // Tratamento de erro de rede ou erro inesperado
        showToast(`Erro de comunicação: ${error.message || 'Erro desconhecido.'}`, 'error');
      });
    });

    function getPerfisSelecionadosCadastro() {
      return $('#perfisCadastroContainer .perfil-checkbox:checked')
        .map((_, el) => parseInt($(el).val(), 10))
        .get();
    }

    function carregarPerfisCadastro() {
      req_GET(opt.urlPerfis).then(result => {
        if (!result.success) {
          showToast(result.message || 'Erro ao carregar perfis.', 'error');
          return;
        }
        const container = $('#perfisCadastroContainer').empty();
        (result.data || []).forEach(p => {
          const item = $(`
            <div class="form-check">
              <input class="form-check-input perfil-checkbox" type="checkbox" id="perfil_cad_${p.id}" value="${p.id}">
              <label class="form-check-label" for="perfil_cad_${p.id}">${p.nome}</label>
            </div>
          `);
          container.append(item);
        });
      }).catch(error => {
        showToast(`Erro de comunicação: ${error.message || 'Erro desconhecido.'}`, 'error');
      });
    }

    carregarPerfisCadastro();

    $('#togglePassword').on('click', function () {
      let passwordField = $('#senha');
      let icon = $('#icon');

      // Alternar o tipo do campo de senha
      passwordField.attr('type', passwordField.attr('type') === 'password' ? 'text' : 'password');

      // Alternar as classes dos ícones
      icon.toggleClass('fa-eye fa-eye-slash');
    });
    
  });

</script>